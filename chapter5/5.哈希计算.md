



# @ohos.file.hash (文件哈希处理)

该模块提供文件哈希处理能力，对文件内容进行哈希处理。

使用该功能模块对文件/目录进行操作前，需要先获取其应用沙箱路径，获取方式及其接口用法请参考：

```js
import { UIAbility } from '@kit.AbilityKit';
import { window } from '@kit.ArkUI';


export default class EntryAbility extends UIAbility {
  onWindowStageCreate(windowStage: window.WindowStage) {
    let context = this.context;
    let pathDir = context.filesDir;
  }
}
```

或者

```js
import { common } from '@kit.AbilityKit';
import { buffer } from '@kit.ArkTS';
import { fileIo, ReadOptions } from '@kit.CoreFileKit';
import { hilog } from '@kit.PerformanceAnalysisKit';


const TAG: string = '[Page_Context]';
const DOMAIN_NUMBER: number = 0xFF00;


@Entry
@Component
struct Index {
  @State message: string = 'Hello World';
  private context = this.getUIContext().getHostContext() as common.UIAbilityContext;


  build() {
    Row() {
      Column() {
        Text(this.message)
        // ...
        Button() {
          Text('create file')
            // ...
            .onClick(() => {
              let applicationContext = this.context.getApplicationContext();
              // 获取应用文件路径
              let filesDir = applicationContext.filesDir;
              hilog.info(DOMAIN_NUMBER, TAG, `filePath: ${filesDir}`);
              // 文件不存在时创建并打开文件，文件存在时打开文件
              let file = fileIo.openSync(filesDir + '/test.txt', fileIo.OpenMode.READ_WRITE | fileIo.OpenMode.CREATE);
              // 写入一段内容至文件
              let writeLen = fileIo.writeSync(file.fd, "Try to write str.");
              hilog.info(DOMAIN_NUMBER, TAG, `The length of str is: ${writeLen}`);
              // 创建一个大小为1024字节的ArrayBuffer对象，用于存储从文件中读取的数据
              let arrayBuffer = new ArrayBuffer(1024);
              // 设置读取的偏移量和长度
              let readOptions: ReadOptions = {
                offset: 0,
                length: arrayBuffer.byteLength
              };
              // 读取文件内容到ArrayBuffer对象中，并返回实际读取的字节数
              let readLen = fileIo.readSync(file.fd, arrayBuffer, readOptions);
              // 将ArrayBuffer对象转换为Buffer对象，并转换为字符串输出
              let buf = buffer.from(arrayBuffer, 0, readLen);
              hilog.info(DOMAIN_NUMBER, TAG, `the content of file: ${buf.toString()}`);
              // 关闭文件
              fileIo.closeSync(file);
            })
        }
        // ...
      }
      // ...
    }
    // ...
  }
}
```

## hash.hash

支持设备PhonePC/2in1Tablet

hash(path: string, algorithm: string): Promise<string>

计算文件的哈希值，使用Promise异步回调。

**参数：**

| 参数名    | 类型   | 必填 | 说明                                                         |
| :-------- | :----- | :--- | :----------------------------------------------------------- |
| path      | string | 是   | 待计算哈希值文件的应用沙箱路径。                             |
| algorithm | string | 是   | 哈希计算采用的算法。可选 "md5"、"sha1" 或 "sha256"。建议采用安全强度更高的 "sha256"。 |

```js
import { BusinessError } from '@kit.BasicServicesKit';
let filePath = pathDir + "/test.txt";
hash.hash(filePath, "sha256").then((str: string) => {
  console.info("calculate file hash succeed:" + str);
}).catch((err: BusinessError) => {
  console.error("calculate file hash failed with error message: " + err.message + ", error code: " + err.code);
});
```



## hash.createHash

支持设备PhonePC/2in1Tablet

createHash(algorithm: string): HashStream;

创建并返回 HashStream 对象，该对象可用于使用给定的 algorithm 生成哈希摘要。

**参数：**

| 参数名    | 类型   | 必填 | 说明                                                         |
| :-------- | :----- | :--- | :----------------------------------------------------------- |
| algorithm | string | 是   | 哈希计算采用的算法。可选 "md5"、"sha1" 或 "sha256"。建议采用安全强度更高的 "sha256"。 |

**返回值：**

| 类型                                                         | 说明                  |
| :----------------------------------------------------------- | :-------------------- |
| [HashStream](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-hash#hashstream12) | HashStream 类的实例。 |

**错误码：**

以下错误码的详细介绍请参见[通用错误码](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-universal#通用错误码)和[基础文件IO错误码](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-filemanagement#基础文件io错误码)。

| 错误码ID | 错误信息          |
| :------- | :---------------- |
| 401      | Parameter error.  |
| 13900020 | Invalid argument. |
| 13900042 | Unknown error.    |

**示例：**

```typescript
// pages/xxx.ets
import { fileIo as fs } from '@kit.CoreFileKit';


function hashFileWithStream() {
  const filePath = pathDir + "/test.txt";
  // 创建文件可读流
  const rs = fs.createReadStream(filePath);
  // 创建哈希流
  const hs = hash.createHash('sha256');
  rs.on('data', (emitData) => {
    const data = emitData?.data;
    hs.update(new Uint8Array(data?.split('').map((x: string) => x.charCodeAt(0))).buffer);
  });
  rs.on('close', async () => {
    const hashResult = hs.digest();
    const fileHash = await hash.hash(filePath, 'sha256');
    console.info(`hashResult: ${hashResult}, fileHash: ${fileHash}`);
  });
}
```

## HashStream



支持设备PhonePC/2in1Tablet

HashStream 类是用于创建数据的哈希摘要的实用工具。由 [createHash](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-hash#hashcreatehash12) 接口获得。

### update12+

支持设备PhonePC/2in1Tablet

update(data: ArrayBuffer): void

使用给定的 data 更新哈希内容，可多次调用。

**示例：**

```typescript
// 创建哈希流
const hs = hash.createHash('sha256');
hs.update(new Uint8Array('1234567890'?.split('').map((x: string) => x.charCodeAt(0))).buffer);
hs.update(new Uint8Array('abcdefg'?.split('').map((x: string) => x.charCodeAt(0))).buffer);
const hashResult = hs.digest();
// 88A00F46836CD629D0B79DE98532AFDE3AEAD79A5C53E4848102F433046D0106
console.info(`hashResult: ${hashResult}`);
```

### digest

支持设备PhonePC/2in1Tablet

digest(): string

计算传给被哈希的所有数据的摘要。

**示例：**

```typescript
// 创建哈希流
const hs = hash.createHash('sha256');
hs.update(new Uint8Array('1234567890'?.split('').map((x: string) => x.charCodeAt(0))).buffer);
hs.update(new Uint8Array('abcdefg'?.split('').map((x: string) => x.charCodeAt(0))).buffer);
const hashResult = hs.digest();
// 88A00F46836CD629D0B79DE98532AFDE3AEAD79A5C53E4848102F433046D0106
console.info(`hashResult: ${hashResult}`);
```